<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Minimal store sample</title>
</head>

<body onload="init_form()">
<div id="message" style="width: 100%;text-align: center;">
  <p>Cette page illustre l'usage de l'API KERBERUS permetant de valider les billets via la blockchain</p>
</div>

<table style="width:100vw;" id="validate_zone">
  <tr>
    <th>Exemple de douchette</th>
    <th>Procédure</th>
  </tr>
  <tr>
    <td style="width: 300px;text-align: left;vertical-align:top;" >
      <form id="frm">

        <div id="events_zone" style="display: none;">
          <label for="selectEvent">Sélectionner un événement:</label>
          <select id="selectEvent">
          </select>
          <br><br>
        </div>
        <br>
        Référence:
        <input id="ref" type="text" value="#001"><br><br>

        <input type="file" accept="image/*;capture=camera"><br><br>
        <button onclick="send()">Commander</button>
      </form>
    </td>
    <td>
      <iframe id="faq" src="https://app.kerberus.tech/faqs.html?faq=validate"
              style="border:none;overflow:hidden;min-height:500px;width:100%;background: none;"></iframe>
    </td>
  </tr>
</table>
</body>

<script>

  var domain="http://localhost:6800";
  var idevent=0;

  function getParam() {
    var vars = {};
    window.location.href.replace(location.hash, '').replace(/[?&]+([^=&]+)=?([^&]*)?/gi, function (m, key, value) { vars[key] = value !== undefined ? value : ''; });
    return vars;
  }

  /**
   * Fonction appelée à l'ouverture de la page
   */
  function init_form() {
    if (!getParam().hasOwnProperty("faq") || screen.availWidth < 500)
      document.getElementById("faq").style.display = "none";

    if (getParam().idevent != null) idevent = getParam().idevent;

    if (idevent == 0) {
      document.getElementById("events_zone").style.display="inline-block";
      fetch(domain + "/api/events/_/dtCreate/online,with_store").then(function (r) {
        r.json().then(function (resp) {
          src="";
          resp.forEach(function(item){
            src="<option value='"+item._id+"'>"+item.name+"</option>";
          });
          document.getElementById("selectEvent").innerHTML=src;
          if(resp==null || resp.length==0){
            document.getElementById("message").innerHTML="<h2>Aucun événement n'est disponible actuellement</h2><br><a href='https://app.kerberus.tech'>CREER LE VOTRE</a>";
            document.getElementById("store_zone").style.display="none";
          }
        });
      });
    }
  }



  /**
   * Fonction appelée pour créer le billet
   */
  function send(){

    var access_token=getParam().access_token;
    if(access_token==null)access_token="tkhh4271!!";

    var ref="";
    ref=document.getElementById("ref").value;
    ref=ref.replace("#","")

    if(idevent==0)idevent=document.getElementById("selectEvent").value;

    var url=domain+"/api/use/"+ref+"/"+idevent;
    url=url.replace("http//","http://").replace("https//","https://");

    fetch(url,
      {
        body: new FormData(document.getElementById('frm')),
        method: "post",
        mode: 'no-cors',
        headers:{"access_token":access_token}
      }).then(function (r) {
        r.json().then(function (resp) {
          var email=document.getElementById("email").value;
          document.getElementById("message").innerHTML="Vous billets sont réservés. Retrouvez les dans l'application <a href='https://app.kerberus.tech/?email="+email+"' target='_blank'>KERBERUS</a>";
      });
    },function(r) {
      console.log(r);
    });
  }
</script>

</html>
