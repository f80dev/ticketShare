<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Minimal store sample</title>
</head>

<body onload="init_form()">
<div id="message" style="width: 100%;text-align: center;">
  <p>Dans cette page illustre l'usage de l'API KERBERUS permetant de sécuriser vos billets dans la blockchain</p>
</div>

<table style="width:100vw;" id="store_zone">
  <tr>
    <th>Exemple minimaliste de boutique</th>
    <th>Procédure</th>
  </tr>
  <tr>
    <td style="width: 300px;text-align: left;vertical-align:top;" >
      <form id="frm">
        <div>
          <label for="email">Email</label>
          <input name="email" id="email" value="paul.dudule@gmail.com">
        </div>
        <br>
        <div id="events_zone" style="display: none;">
          <label for="selectEvent">Sélectionner un événement</label>
          <select id="selectEvent">
          </select>
          <br><br>
        </div>

        <div>
          <label for="tickets">Combien de billets</label>
          <input name="tickets" type="number" size="3" id="tickets" value="2" max="10" min="0">
        </div>
        <br>
        <div>
          <label for="price">Prix</label>
          <input name="price" type="number" id="price" value="30" max="300" min="0">
        </div>
        <br>
        <div>
          <label for="date">Date</label>
          <input name="date" type="date" id="date" value="2021-01-01">
        </div>

        <div>
          <br>
        </div>
      </form>

      <button onclick="send()">Commander</button>
    </td>
    <td>
      <iframe id="faq" src="https://app.kerberus.tech/faqs.html?faq=extern_store"
              style="border:none;overflow:hidden;min-height:500px;width:100%;background: none;"></iframe>
    </td>
  </tr>
</table>
</body>

<script>

  var domain="http://localhost:6800";
  var idevent=0;

  function getParam() {
    var vars = {};
    window.location.href.replace(location.hash, '').replace(/[?&]+([^=&]+)=?([^&]*)?/gi, function (m, key, value) { vars[key] = value !== undefined ? value : ''; });
    return vars;
  }

  /**
   * Fonction appelée à l'ouverture de la page
   */
  function init_form() {
    //faq consiste à afficher de l'aide
    if (!getParam().hasOwnProperty("faq") || screen.availWidth < 500)
      document.getElementById("faq").style.display = "none";

    //permet un pré-remplissage de l'identité du client
    if (getParam().hasOwnProperty("email"))
      document.getElementById("email").value = getParam().email;

    if (getParam().idevent != null) idevent = getParam().idevent;

    if (getParam().domain != null) domain = getParam().domain;

    if (idevent == 0) {

      document.getElementById("events_zone").style.display="inline-block";
      fetch(domain + "/api/events/_/dtCreate/online,with_store").then(function (r) {
        r.json().then(function (resp) {
           src="";
           resp.forEach(function(item){
             src="<option value='"+item._id+"'>"+item.name+"</option>";
           });
           document.getElementById("selectEvent").innerHTML=src;
           if(resp==null || resp.length==0){
             document.getElementById("message").innerHTML="<h2>Aucun événement n'est disponible actuellement</h2><br><a href='https://app.kerberus.tech'>CREER LE VOTRE</a>";
             document.getElementById("store_zone").style.display="none";
           }
        });
      });
    }
  }



  /**
   * Fonction appelée pour créer le billet
   */
  function send(){

    var access_token=getParam().access_token;
    if(access_token==null)access_token="tkhh4271!!";

    if(idevent==0)idevent=document.getElementById("selectEvent").value;

    var url=domain+"/api/add_ticket/"+idevent;
    url=url.replace("http//","http://").replace("https//","https://");
    fetch(url,
      {
        body: new FormData(document.getElementById('frm')),
        method: "post",
        mode: 'no-cors',
        headers:{"access_token":access_token}
      }).then(function (r) {
        r.json().then(function (resp) {
          var email=document.getElementById("email").value;
          document.getElementById("message").innerHTML="Vous billets sont réservés. Retrouvez les dans l'application <a href='https://app.kerberus.tech/?email="+email+"' target='_blank'>KERBERUS</a>";
      });
    },function(r) {
      console.log(r);
    });
  }
</script>

</html>
